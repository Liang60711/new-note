
# 名詞解釋

## 使用者資料庫 和 系統資料庫([reference](https://ithelp.ithome.com.tw/articles/10256104))
SQL Server 把資料庫區分為**使用者資料庫**和**系統資料庫**，其中系統資料庫分為: 
1. master: 
	* 記錄包含所有有關 SQL Server 資料庫配置的重要資訊與設定。
	* 如果 master 資料庫毀損或者是遺失，將沒有辦法重新啟動 SQL Server。
2. model:
	* 資料庫模板，當建立一個新的資料庫時，SQL Server 就會以 model 資料庫做為樣板來新增資料庫。
3. msdb:
	* 用於 SQL Server agent 的排程與作業。
	* 資料庫備份與復原的歷史紀錄都是記載在 msdb 資料庫。
4. tempdb:
	* 用來儲存臨時資料表，stored procedure、cursor 以及資料的排序。
	* 如果不當使用 tempdb 資料庫，tempdb 有可能會不正常的快速成長，這會造成資料庫的問題。一般來講，會建議將 tempdb 資料庫放在與其他資料庫不同的儲存空間。


## SQL Server Agent
為 SQL Server 提供自動化服務的組件。

## ODBC JDBC
ODBC 驅動程式: Open Database Connectivity，windows 應用程式連結資料庫的 API。
JDBC 驅動程式: Java Database Connectivity，Java 應用程式連結資料庫的 API。

連結:
`windows Application -> ODBC -> connection URL -> Database`

## cluster
* 指多台電腦透過某些技術或架構運作成單一系統，共同提供服務，多台電腦互相為備援，以維持伺服器與應用程式運作時間，確保服務的可用性。
* 在叢集中我們常以節點 (Node) 來稱呼叢集主機。

## ESX host 和 vMotion
* ESX host: VMware 的 cluster。
* vMotion: VMware 技術，將工作負載從預計發生停機的 ESX host 移轉到另一部 ESX host 上。

	* 舉例: vm 所在的 ESX host 出現系統資源 (如 CPU, RAM) 短缺的問題, VMware 在偵測到這種情況之下，就有可能把這個 vm 移轉 (v-motion) 到另外一個可用的 ESX host 通常 v-motion 也可以被視為高可用性 (HA: High Availability，指系統無中斷地執行其功能的能力) 及災難復原 (DR: Disaster Recovery) 的方法之一。

## VM snapshot
虛擬主機快照，VM 虛擬主機層級的備份。

## Scalability 可伸縮性、可擴展性
* 縱向的可伸縮性: 在同一個邏輯單元內增加資源來提高處理能力。這樣的例子包括在現有伺服器上增加 CPU，或者在現有的 RAID/SAN 儲存中增加硬碟來提高儲存量。
* 橫向的可伸縮性: 增加更多邏輯單元的資源，並令它們像是一個單元一樣工作。大多數叢集方案、分散式檔案系統、負載平衡提高橫向的可伸縮性。
* RDBMS (一台機器跑一個服務或多個服務) 透過縱向的擴展；noSQL (多個機器跑一個服務) 則透過橫向擴展。

<br/>

<br/>



# 安裝
1. 安裝版本 2014 express 64bits。
2. 安裝 SSMS (SQL server management studio)。


## 登入
1. Windows 驗證登入: 把帳戶管理權限交給 Windows 作業系統。
2. SQL server 驗證登入: 由 SQL Server 自己管理帳戶設定，包含使用者帳戶與密碼，需自行建立帳密。
* 兩者的差別在於驗證的模組不同，但授權的模組都在 SQL Server，所以不論是用哪種帳戶，都要在 SQL Server 中建立登入帳戶才能使用。

## 權限
1. 不同的使用者，有不同的權限，一開始可以由 sa (最高權限)，對其他的用戶進行瀏覽權限；`右鍵使用者 >> 屬性 >> 使用者對應 >> 選擇db >> 選擇db_owner或其他`。



# 資料庫備份 還原
## 使用 GUI 備份
* 右鍵資料庫 >> 工作 >> 備份 >> 副檔名為 `.bak`。

## 使用 GUI 還原
* 右鍵資料庫 >> 還原資料庫 >> 來源(裝置) >> 選取 bak 檔案 >> 確定。

## 使用 卸離 & 附加
* 卸離: 好處是不用將檔案刪除，斷開連接。
* 附加: 將資料庫重新連接。

<br/>

<br/>

# 資料型態 (字串)
* CHAR
* NCHAR
* VARCHAR
* NVARCHAR
## 效能
有 VAR 必須記錄(查詢)地址，速度較慢。  
* CHAR > VARCHAR  
* NCHAR > NVARCHAR
## 儲存空間
* N 使用 unicode 儲存，儲存空間為兩倍
* T-SQL 儲存 VARCHAR 會多 2 Bytes 來儲存地址

|型態|空間(Byte)|建議儲存資料|
|--|--|--|
|CHAR(n)|n|長度固定，只有英文字母、數字|
|VARCHAR(n)|n+2|長度不固定，有非英文字母、數字|
|NCHAR(n)|2*n|長度固定，有中文|
|NVARCHAR(n)|2*n+2|長度不固定，有非英文字母、數字||

<br/>

<br/>

# 操作 Database
## Create db
使用腳本建立資料庫(不會自動建立目錄，需手動建立 C:\DATA)
```sql
CREATE DATABASE sales 
ON PRIMARY(
	NAME='sale_dat',
	FILENAME='C:\DATA\saledat.mdf',
	SIZE=10,
	MAXSIZE=50,
	FILEGROWTH=5)
LOG ON(
	NAME='sale_log',
	FILENAME='C:\DATA\salelog.ldf',
	SIZE=5,
	MAXSIZE=25,
	FILEGROWTH=5
);

-- 主文件附檔名 .mdf
-- 日誌附檔名 .ldf
-- SIZE 文件初始值大小，單位 MB；FILEGROWTH 為每次增加的大小。
```

## Alter db
修改 db 名稱
```sql
ALTER DATABASE testdb01
MODIFY NAME=testdb02;
```
修改 db 屬性
```sql
-- 指定 db 中名為 testdb01 檔案，進行屬性修改
ALTER DATABASE testdb02
MODIFY FILE(
	NAME=testdb01
	SIZE=20MB,
	MAXSIZE=80MB,
	FILEGROWTH=10MB
);
```
查看修改是否成功
```sql
EXEC SP_HELPDB TESTDB;
```
## Drop db
刪除 db，需要先變更 連接的資料庫(左上角)，才能刪除。
```
DROP DATABASE testdb02;
```
<br/>

<br/>

# 操作 Table
## 修改 Table 屬性
修改欄位的長度
```SQL
ALTER TABLE person
ALTER COLUMN first_name VARCHAR(150);
```
修改欄位資料類型
```sql
ALTER TABLE person
ALTER COLUMN age BIGINT;
```
修改欄位名稱
```sql
-- '表名.原欄位名', '修改欄位名', 'COLUMN'
EXEC sp_rename 'person.first_name', 'f_name', 'COLUMN';
```
添加新欄位
```sql
-- ADD
ALTER TABLE person
ADD last_name VARCHAR(20) NOT NULL;
```

新增 <code>NOT NULL</code>
```sql
ALTER TABLE person
ALTER COLUMN test_id INT NOT NULL;
```
新增 <code>Primary Key</code>
```sql
ALTER TABLE person
ADD CONSTRAINT test_id PRIMARY kEY(id);
-- ADD CONSTRAINT <主鍵名> PRIMARY KEY(欄位名)
```
新增 <code>Foreign Key</code>
```sql
ALTER TABLE person
ADD CONSTRAINT FK_P FORREIGN KEY(city_id)	-- 從表
REFERENCES city(id);	-- 主表
```

## 刪除 Table 
```sql
DROP TABLE person
```

## 增加 foreign key
從表增加 foreign key
```sql
ALTER TABLE person
ADD CONSTRAINT pk_city	-- primary key 名稱
FORREIGN KEY (city_id)
REFERENCES city(id);
```
從表刪除 foreign key
```sql
ALTER TABLE person
DROP CONSTRAINT pk_city	  -- primary key 名稱
```

## 插入資料
一般插入
```sql
INSERT INTO user(userid, username, email)
VALUES ('AAA', '一二三', 'LI@mail.com');
```
複製其他資料表資料進來
```sql
-- 將 user_new 資料 copy 給 user
INSERT INTO user(userid, username, email)
SELECT userid, username, email FROM user_new;
```

## 查詢資料
DISTINCT
```sql
SELECT DISTINCT username
FROM user;
```
TOP 查詢前幾筆資料 (沒有 LIMIT)
```sql
SELECT TOP 200 *
FROM user;
```
BETWEEN 可以使用在 數字、字母、時間
```SQL
-- 字母
SELECT * FROM user
WHERE username BETWEEN '9A' AND '9G'; 

-- 時間
SELECT * FROM user
WHERE created_at BETWEEN '2020-01-01' AND '2021-01-01 23:59:59.999';

-- 查詢例外 NOT BETWEEN
-- GETDATE() 為 server 時間
SELECT * FROM user
WHERE created_at NOT BETWEEN '2020-01-01' AND GETDATE();
```
IN 多項查詢
```sql
SELECT * FROM user
WHERE age in (20, 22, 24);
```
AS 取名
```sql
-- 資料表取別名為 u，前面欄位就可以用 u.username
SELECT u.username FROM user AS u;

-- AS 可以省略，空一格
SELECT u.username FROM user u;
```
EXISTS 會附帶一個子句，依照子句返回 true/false
```SQL
-- 取出符合 A.id=B.id 為條件的所有欄位。
SELECT * FROM user_1 AS A
WHERE EXISTS 
(SELECT * FROM user_2 AS B WHERE A.id=B.id);

-- 等價於 (使用 IN)
SELECT * FROM user_1
WHERE id 
in (SELECT id FROM user_2);
```
## IN EXISTS JOIN 選擇
* 外: user_1 ； 內: user_2
1. 大表在外小表在內，使用 IN
2. 小表在外大表在內，使用 EXISTS
3. 兩資料表數量差異不大，使用 JOIN

## 更新資料
```sql
UPDATE user
SET username='BBB'
WHERE id=1;
```
## 刪除資料
```SQL
-- FROM 可以省略
DELETE FROM user
WHERE id=5;
```

<br/>

<br/>

# 與 mySQL 不同的部分
## GO
GO 可以將 SQL 語句進行提交，並可以加入提交次數。
```sql
INSERT INTO user(userid, username, email)
VALUES ('123', 'AAA', 'AAA@mail.com');
GO 2

-- GO 後面不可加 ;
```

## AUTO_INCREMENT
```sql
-- mySQL
AUTO_INCREMENT

-- T-SQL
-- 從1開始，每次加2
IDENTITY(1,2)
```

## TOP LIMIT
```SQL
-- mySQL
LIMIT 100
-- T-SQL
TOP 100
```